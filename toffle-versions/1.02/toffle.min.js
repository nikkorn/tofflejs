function toffle(){}var updOpen="<^",updClose="^>",updContentClose="<^/^>";toffle.tokenType={IF:function(){this.type="if",this.condition="",this.tokens=[],this.wrapsTokens=!0},NOT:function(){this.type="not",this.condition="",this.tokens=[],this.wrapsTokens=!0},REF:function(){this.type="ref",this.value="",this.wrapsTokens=!1},TEMP:function(){this.type="template",this.template="",this.params="",this.wrapsTokens=!1},FOR:function(){this.type="for",this.pointer="",this.reference="",this.tokens=[],this.wrapsTokens=!0},CONTENT:function(){this.type="content",this.value="",this.wrapsTokens=!1},CLS:function(){this.type="cls",this.wrapsTokens=!1}},toffle.template=function(template){toffle.$={},templates=[],pendingTemplates=[],toffle.compileTemplate(template,!0,pendingTemplates,templates);for(var returnObject=({templates:{},go:function(inputParams){var output="",workStack=[],context={pos:0,tokens:[],params:{},preParams:{},pointer:null,iterative:null,counter:1,iterations:1};for(var templateId in this.templates){var currentTemplate=this.templates[templateId];if(currentTemplate.isInitialTemplate){for(var i=0;i<currentTemplate.ast.tokens.length;i++)context.tokens.push(currentTemplate.ast.tokens[i]);context.params=inputParams,toffle.raiseParams(context.params),workStack.push(context);break}}for(;;){var context;if(0==workStack.length)break;if(context=workStack[workStack.length-1],context.pos==context.tokens.length){if(!(context.counter<context.iterations)){toffle.dropParams(context.params),toffle.raiseParams(context.preParams),workStack.pop();continue}context.counter=context.counter+1,context.pointer=context.iterative[context.counter-1],window[context.pointerIdent]=context.pointer,context.pos=0}var pos=context.pos,token=context.tokens[context.pos];switch(token.type){case"content":output+=token.value;break;case"ref":try{output+=eval(token.value)}catch(err){throw"toffle: error evaluating value '"+token.value+"'"}break;case"if":try{var condition=eval(token.condition)}catch(err){throw"toffle: error evaluating condition '"+token.condition+"'"}condition&&workStack.push({pos:0,tokens:token.tokens,params:{},preParams:{},pointer:null,iterative:null,counter:1,iterations:1});break;case"not":try{var condition=eval(token.condition)}catch(err){throw"toffle: error evaluating condition '"+token.condition+"'"}condition||workStack.push({pos:0,tokens:token.tokens,params:{},preParams:{},pointer:null,iterative:null,counter:1,iterations:1});break;case"for":var ref={},refLength=0;try{ref=eval(token.reference),refLength=ref.length}catch(err){throw"toffle: error evaluating reference '"+token.reference+"'"}workStack.push({pos:0,tokens:token.tokens,params:{},preParams:{},pointer:ref[0],pointerIdent:token.pointer,iterative:ref,counter:1,iterations:refLength}),window.hasOwnProperty(token.pointer)&&(workStack[workStack.length-1].preParams[token.pointer]=window[token.pointer]);try{window[token.pointer]=ref[0]}catch(err){throw"toffle: error setting variable"}break;case"template":for(var targetTemplate=this.templates[token.template],templateContext={pos:0,tokens:[],params:{},preParams:{},pointer:{},iterative:{},counter:1,iterations:1},i=0;i<targetTemplate.ast.tokens.length;i++)templateContext.tokens.push(targetTemplate.ast.tokens[i]);templateContext.params=toffle.parseParam(token.params);for(var key in templateContext.params)window.hasOwnProperty(key)&&(templateContext.preParams[key]=window[key]);toffle.raiseParams(templateContext.params),workStack.push(templateContext);break;default:throw"toffle: error! Unknown token type: "+token.type}context.pos=context.pos+1}return output},goAway:function(e){if(!e)throw"toffle: error! you must specify details for this function";if(!("url"in e))throw"toffle: error! no url specified";if(!("type"in e))throw"toffle: error! no type specified";try{var t;t=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");var r=this;t.onreadystatechange=function(){if(4==t.readyState&&200==t.status){var o;try{o=JSON.parse(t.responseText)}catch(n){return void r.handleAjaxError(e,n,"toffle: error parsing returned data as JSON")}var a;try{a=r.go(o)}catch(n){return void r.handleAjaxError(e,n,"toffle: error generating output")}if("dropoff"in e)try{e.dropoff.innerHTML=a}catch(n){return void r.handleAjaxError(e,n,"toffle: error! invalid dropoff")}"finished"in e&&e.finished({responseJSON:o,output:a})}},t.open(e.type,e.url,!0),"data"in e&&"POST"==e.type.toUpperCase()?t.send(e.data):t.send()}catch(o){this.handleAjaxError(e,o,"toffle: error carrying out ajax request")}},goOver:function(){},handleAjaxError:function(e,t,r){if(!("failed"in e))throw r;e.failed(t)}}),i=0;i<templates.length;i++)returnObject.templates[templates[i].name]={ast:templates[i].temp.AST,isInitialTemplate:templates[i].temp.initialTemplate,varList:[]};return returnObject},toffle.compileTemplate=function(e,t,r,o){if(null==e)throw"toffle: Compilation failed! Could not find Template.";var n={initialTemplate:t,tokens:[],openTokens:[],AST:{},templateString:e.innerHTML};r.push(e.id);for(var a=!1,i="",s=0;s<n.templateString.length-1;s++){if(n.templateString.slice(s,s+2)==updOpen){if(i.length>0){var p=new toffle.tokenType.CONTENT;p.value=i,n.tokens.push(p),i=""}n.openTokens.push(s),a=!0}else if(n.templateString.slice(s,s+2)==updClose){s+=2,a=!1;var l=n.openTokens.pop(),f=n.templateString.slice(l,s);f=toffle.tokenify(f,e.id,r),f.tokenIndex=s-l,n.tokens.push(f)}a||(i+=n.templateString.charAt(s))}if(i.length>0){var p=new toffle.tokenType.CONTENT;p.value=i,n.tokens.push(p),i=""}if(n.openTokens.length>0)throw"toffle: Compilation failed! No closing '^>'";var c=toffle.generateTokenAST(n);n.AST=c,o.push({name:e.id,temp:n})},toffle.tokenify=function(e,t,r){var o;if(e==updContentClose)return new toffle.tokenType.CLS;e=e.replace("<^",""),e=e.replace("^>",""),e=e.trim();var n=e.split(" ");switch(n[0]){case"plug":o=new toffle.tokenType.TEMP,o.template=n[1];for(var a=document.getElementById(o.template),i=!1,s=0;s<r.length;s++)if(r[s]==o.template){i=!0;break}if(o.template==t||i||toffle.compileTemplate(a,!1,r,templates),n.length>2){for(var p="",l=2;l<n.length;l++)p+=n[l];o.params=p}else o.params="";break;case"for":if(o=new toffle.tokenType.FOR,!(n.length>3))throw"toffle: Compilation failed! Incorrect 'for' declaration.";if("in"!=n[2])throw"toffle: Compilation failed! Incorrect 'for' declaration, missing 'in'.";o.pointer=n[1],n.splice(0,3),o.reference=n.join(" ");break;case"if":if(o=new toffle.tokenType.IF,!(n.length>1))throw"toffle: Compilation failed! Missing 'if' condition.";n.splice(0,1),o.condition=n.join(" ");break;case"not":if(o=new toffle.tokenType.NOT,!(n.length>1))throw"toffle: Compilation failed! Missing 'not' condition.";n.splice(0,1),o.condition=n.join(" ");break;default:o=new toffle.tokenType.REF,o.value=e}return o},toffle.generateTokenAST=function(e){var t=[];t.push({tokens:[]});for(var r=0;r<e.tokens.length;r++){var o=e.tokens[r];if(o.wrapsTokens)t.push(o);else if("cls"==o.type){var n=t.pop();t[t.length-1].tokens.push(n)}else{var n=t[t.length-1];n.tokens.push(o)}}return t[0]},toffle.raiseParams=function(e){for(var t in e)window[t]=e[t]},toffle.dropParams=function(e){for(var t in e)delete window[t]},toffle.parseParam=function(param){if(param=param.trim(),"("==param.charAt(0)&&")"==param.charAt(param.length-1)){var outputParams={};param=param.substring(1,param.length-1);for(var params=param.split(","),i=0;i<params.length;i++){if(currentParam=params[i].trim(),currentParamSections=currentParam.split(":"),2!=currentParamSections.length)throw"toffle: Error evaluating parameter alias: "+currentParam;var alias=currentParamSections[0],paramvalue=currentParamSections[1];try{evaluatedValue=eval(paramvalue)}catch(err){evaluatedValue=paramvalue}outputParams[alias]=evaluatedValue}return outputParams}throw"toffle: Error evaluating parameter input, must be wrappend in parenthesis: "+param},toffle.destringToken=function(e){for(var t=e,r=[],o=0,n=/\"(.*?)\"/g,a=/\'(.*?)\'/g,i=!1;!i;){var s=n.exec(t);if(null!=s){{s.index}t=t.replace(s[0],"^UTR:"+o+"^"),r.push({id:o++,resource:s[0],value:s[1],pos:s.index})}else i=!0}for(i=!1;!i;){var s=a.exec(t);null!=s?(t=t.replace(s[0],"^UTR:"+o+"^"),r.push({id:o++,resource:s[0],value:s[1],pos:s.index})):i=!0}return{token:t,resourceLibrary:r}};