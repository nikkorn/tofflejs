function toffle(){}var updOpen="<^",updClose="^>",updContentClose="<^/^>";toffle.tokenType={IF:function(){this.type="if",this.condition="",this.tokens=[],this.wrapsTokens=!0},NOT:function(){this.type="not",this.condition="",this.tokens=[],this.wrapsTokens=!0},REF:function(){this.type="ref",this.value="",this.wrapsTokens=!1},TEMP:function(){this.type="template",this.template="",this.params="",this.wrapsTokens=!1},EACH:function(){this.type="each",this.pointer="",this.reference="",this.tokens=[],this.wrapsTokens=!0},CONTENT:function(){this.type="content",this.value="",this.wrapsTokens=!1},HELPER:function(){this.type="helper",this.func=null,this.wrapsTokens=!1},CLS:function(){this.type="cls",this.wrapsTokens=!1}},toffle.template=function(e){var t={},r=[],n=[];if(e)if(e.nodeType&&1===e.nodeType){if("text/toffle-template"!=e.type)throw"toffle: template DOM element must be defined as type 'text/toffle-template'"}else{if(!("template"in e))throw"toffle: error! you must provide an initial template";if("helpers"in e)for(var a in e.helpers)t[a]=e.helpers[a];e=e.template}toffle.compileTemplate(e,!0,n,r);for(var o=({templates:{},go:function(e){var t="",r=[],n={pos:0,tokens:[],params:{},preParams:{},pointer:null,iterative:null,counter:1,iterations:1};for(var a in this.templates){var o=this.templates[a];if(o.isInitialTemplate){for(var i=0;i<o.ast.tokens.length;i++)n.tokens.push(o.ast.tokens[i]);n.params=e,r.push(n);break}}for(;;){var n;if(0==r.length)break;if(n=r[r.length-1],n.pos==n.tokens.length){if(!(n.counter<n.iterations)){r.pop();continue}n.counter=n.counter+1,n.pointer=n.iterative[n.counter-1],n.pos=0}var s=(n.pos,n.tokens[n.pos]);switch(s.type){case"content":t+=s.value;break;case"ref":try{var l=this.getParamPool(r),f=this.parseReference(s.value).idents,p=this.grabValue(l,f);t+=p}catch(h){throw"toffle: error evaluating value '"+s.value+"'"}break;case"if":try{var l=this.getParamPool(r),f=this.parseReference(s.condition).idents,p=this.grabValue(l,f),u=p}catch(h){throw"toffle: error evaluating condition '"+s.condition+"'"}u&&r.push({pos:0,tokens:s.tokens,params:{},preParams:{},pointer:null,iterative:null,counter:1,iterations:1});break;case"not":try{var l=this.getParamPool(r),f=this.parseReference(s.condition).idents,p=this.grabValue(l,f),u=p}catch(h){throw"toffle: error evaluating condition '"+s.condition+"'"}u||r.push({pos:0,tokens:s.tokens,params:{},preParams:{},pointer:null,iterative:null,counter:1,iterations:1});break;case"each":var c={},m=0;try{var l=this.getParamPool(r),f=this.parseReference(s.reference).idents,p=this.grabValue(l,f),c=p;m=c.length}catch(h){throw"toffle: error evaluating reference '"+s.reference+"'"}r.push({pos:0,tokens:s.tokens,params:{},preParams:{},pointer:c[0],pointerIdent:s.pointer,iterative:c,counter:1,iterations:m});break;case"template":for(var g=this.templates[s.template],d={pos:0,tokens:[],params:{},preParams:{},pointer:{},iterative:{},counter:1,iterations:1},i=0;i<g.ast.tokens.length;i++)d.tokens.push(g.ast.tokens[i]);d.params=toffle.parseParam(s.params,this.getParamPool(r)),r.push(d);break;default:throw"toffle: error! Unknown token type: "+s.type}n.pos=n.pos+1}return t},getParamPool:function(e){for(var t={},r=0;r<e.length;r++){var n=e[r];for(var a in n.params)t[a]=n.params[a];n.pointerIdent&&(t[n.pointerIdent]=n.pointer)}return t},goAway:function(e){if(!e)throw"toffle: error! you must specify details for this function";if(!("url"in e))throw"toffle: error! no url specified";if(!("type"in e))throw"toffle: error! no type specified";try{var t;t=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");var r=this;t.onreadystatechange=function(){if(4==t.readyState&&200==t.status){var n;try{n=JSON.parse(t.responseText)}catch(a){return void r.handleAjaxError(e,a,"toffle: error parsing returned data as JSON")}var o;try{o=r.go(n)}catch(a){return void r.handleAjaxError(e,a,"toffle: error generating output")}if("dropoff"in e)try{e.dropoff.innerHTML=o}catch(a){return void r.handleAjaxError(e,a,"toffle: error! invalid dropoff")}"finished"in e&&e.finished({responseJSON:n,output:o})}},t.open(e.type,e.url,!0),"data"in e&&"POST"==e.type.toUpperCase()?t.send(e.data):t.send()}catch(n){this.handleAjaxError(e,n,"toffle: error carrying out ajax request")}},goOver:function(){},grabValue:function(e,t){var r=e;if(void 0==r)return void 0;for(var n=0;n<t.length;n++){var a=t[n].sub;if(a.length>0){if(r=r[t[n].name][grabValue(e,t[n].sub)],t[n].subTrail)for(var o=0;o<t[n].subTrail.length;o++){var i=t[n].subTrail[o];r=r[grabValue(e,i)]}}else r=r[t[n].name];if(void 0==r)return void 0}return r},parseReference:function(e){for(var t=0,r=[],n="",a=0;a<e.length;a++){var o=e.charAt(a);if("."==o)n.length>0&&r.push({name:n.trim(),sub:[]}),n="";else if("["==o)if(n.length>0&&r.push({name:n.trim(),sub:[]}),n="","["==e.charAt(a+1)){for(var i=!1,s=a+2;s<e.length-1;s++)if("]]"==e.substring(s,s+2)){i=!0,r.push({name:e.substring(a+2,s),sub:[],literal:!0});break}if(!i)throw"toffle: No closing ']]' for literal identifier";t+=s-a+1,a+=s-a+1}else{var l=parseReference(e.substring(a+1));0==r[r.length-1].sub.length?r[r.length-1].sub=l.idents:r[r.length-1].subTrail?r[r.length-1].subTrail.push(l.idents):(r[r.length-1].subTrail=[],r[r.length-1].subTrail.push(l.idents)),t+=l.count,a+=l.count}else{if("]"==o)return n.length>0&&r.push({name:n.trim(),sub:[]}),{idents:r,count:t+1};n+=o}t++}return n.length>0&&r.push({name:n.trim(),sub:[]}),t+=n.length,{idents:r,count:t}},handleAjaxError:function(e,t,r){if(!("failed"in e))throw r;e.failed(t)}}),i=0;i<r.length;i++)o.templates[r[i].name]={ast:r[i].temp.AST,isInitialTemplate:r[i].temp.initialTemplate,varList:[]};return o},toffle.compileTemplate=function(e,t,r,n){if(null==e)throw"toffle: Compilation failed! Could not find Template.";var a={initialTemplate:t,tokens:[],openTokens:[],AST:{},templateString:e.innerHTML};r.push(e.id);for(var o=!1,i="",s=0;s<a.templateString.length-1;s++){if(a.templateString.slice(s,s+2)==updOpen){if(i.length>0){var l=new toffle.tokenType.CONTENT;l.value=i,a.tokens.push(l),i=""}a.openTokens.push(s),o=!0}else if(a.templateString.slice(s,s+2)==updClose){s+=2,o=!1;var f=a.openTokens.pop(),p=a.templateString.slice(f,s);p=toffle.tokenify(p,e.id,r,n),p.tokenIndex=s-f,a.tokens.push(p)}o||(i+=a.templateString.charAt(s))}if(i.length>0){var l=new toffle.tokenType.CONTENT;l.value=i,a.tokens.push(l),i=""}if(a.openTokens.length>0)throw"toffle: Compilation failed! No closing '^>'";var h=toffle.generateTokenAST(a);a.AST=h,n.push({name:e.id,temp:a})},toffle.tokenify=function(e,t,r,n){var a;if(e==updContentClose)return new toffle.tokenType.CLS;e=e.replace("<^",""),e=e.replace("^>",""),e=e.trim();var o=e.split(" ");switch(o[0]){case"plug":a=new toffle.tokenType.TEMP,a.template=o[1];for(var i=document.getElementById(a.template),s=!1,l=0;l<r.length;l++)if(r[l]==a.template){s=!0;break}if(a.template==t||s||toffle.compileTemplate(i,!1,r,n),o.length>2){for(var f="",p=2;p<o.length;p++)f+=o[p];a.params=f}else a.params="";break;case"each":if(a=new toffle.tokenType.EACH,!(o.length>3))throw"toffle: Compilation failed! Incorrect 'each' declaration.";if("in"!=o[2])throw"toffle: Compilation failed! Incorrect 'each' declaration, missing 'in'.";a.pointer=o[1],o.splice(0,3),a.reference=o.join(" ");break;case"if":if(a=new toffle.tokenType.IF,!(o.length>1))throw"toffle: Compilation failed! Missing 'if' condition.";o.splice(0,1),a.condition=o.join(" ");break;case"not":if(a=new toffle.tokenType.NOT,!(o.length>1))throw"toffle: Compilation failed! Missing 'not' condition.";o.splice(0,1),a.condition=o.join(" ");break;default:a=new toffle.tokenType.REF,a.value=e}return a},toffle.generateTokenAST=function(e){var t=[];t.push({tokens:[]});for(var r=0;r<e.tokens.length;r++){var n=e.tokens[r];if(n.wrapsTokens)t.push(n);else if("cls"==n.type){var a=t.pop();t[t.length-1].tokens.push(a)}else{var a=t[t.length-1];a.tokens.push(n)}}return t[0]},toffle.parseParam=function(e,t){if(e=e.trim(),"("==e.charAt(0)&&")"==e.charAt(e.length-1)){var r={};e=e.substring(1,e.length-1);for(var n=e.split(","),a=0;a<n.length;a++){if(currentParam=n[a].trim(),currentParamSections=currentParam.split(":"),2!=currentParamSections.length)throw"toffle: Error evaluating parameter alias: "+currentParam;var o=currentParamSections[0],i=currentParamSections[1];r[o]=t[i]}return r}throw"toffle: Error evaluating parameter input, must be wrappend in parenthesis: "+e};