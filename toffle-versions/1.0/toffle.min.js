function toffle(){}var updOpen="<^",updClose="^>",updContentClose="<^/^>";toffle.tokenType={IF:function(){this.type="if",this.condition="",this.tokens=[],this.wrapsTokens=!0},NOT:function(){this.type="not",this.condition="",this.tokens=[],this.wrapsTokens=!0},REF:function(){this.type="ref",this.value="",this.wrapsTokens=!1},TEMP:function(){this.type="template",this.template="",this.params="",this.wrapsTokens=!1},FOR:function(){this.type="for",this.pointer="",this.reference="",this.tokens=[],this.wrapsTokens=!0},CONTENT:function(){this.type="content",this.value="",this.wrapsTokens=!1},CLS:function(){this.type="cls",this.wrapsTokens=!1}},toffle.$={},toffle.templates=[],toffle.pendingTemplates=[],toffle.template=function(template){toffle.compileTemplate(template,!0);for(var returnObject={templates:{},go:function(inputParams){var output="",workStack=[],context={pos:0,tokens:[],params:{},preParams:{},pointer:null,iterative:null,counter:1,iterations:1};for(var templateId in this.templates){var currentTemplate=this.templates[templateId];if(currentTemplate.isInitialTemplate){for(var i=0;i<currentTemplate.ast.tokens.length;i++)context.tokens.push(currentTemplate.ast.tokens[i]);context.params=inputParams,toffle.raiseParams(context.params),workStack.push(context);break}}for(;;){var context;if(0==workStack.length)break;if(context=workStack[workStack.length-1],context.pos==context.tokens.length){if(!(context.counter<context.iterations)){toffle.dropParams(context.params),toffle.raiseParams(context.preParams),workStack.pop();continue}context.counter=context.counter+1,context.pointer=context.iterative[context.counter-1],window[context.pointerIdent]=context.pointer,context.pos=0}var pos=context.pos,token=context.tokens[context.pos];switch(token.type){case"content":output+=token.value;break;case"ref":try{output+=eval(token.value)}catch(err){}break;case"if":try{var condition=eval(token.condition)}catch(err){}condition&&workStack.push({pos:0,tokens:token.tokens,params:{},preParams:{},pointer:null,iterative:null,counter:1,iterations:1});break;case"not":try{var condition=eval(token.condition)}catch(err){}condition||workStack.push({pos:0,tokens:token.tokens,params:{},preParams:{},pointer:null,iterative:null,counter:1,iterations:1});break;case"for":var ref={},refLength=0;try{ref=eval(token.reference),refLength=ref.length}catch(err){}workStack.push({pos:0,tokens:token.tokens,params:{},preParams:{},pointer:ref[0],pointerIdent:token.pointer,iterative:ref,counter:1,iterations:refLength}),window.hasOwnProperty(token.pointer)&&(workStack[workStack.length-1].preParams[token.pointer]=window[token.pointer]);try{window[token.pointer]=ref[0]}catch(err){}break;case"template":for(var targetTemplate=this.templates[token.template],templateContext={pos:0,tokens:[],params:{},preParams:{},pointer:{},iterative:{},counter:1,iterations:1},i=0;i<targetTemplate.ast.tokens.length;i++)templateContext.tokens.push(targetTemplate.ast.tokens[i]);templateContext.params=toffle.parseParam(token.params);for(var key in templateContext.params)window.hasOwnProperty(key)&&(templateContext.preParams[key]=window[key]);toffle.raiseParams(templateContext.params),workStack.push(templateContext);break;default:throw"toffle: error! Unknown token type: "+token.type}context.pos=context.pos+1}return output}},i=0;i<toffle.templates.length;i++)returnObject.templates[toffle.templates[i].name]={ast:toffle.templates[i].temp.AST,isInitialTemplate:toffle.templates[i].temp.initialTemplate,varList:[]};return returnObject},toffle.compileTemplate=function(e,t){if(null==e)throw"toffle: Compilation failed! Could not find Template.";var n={initialTemplate:t,tokens:[],openTokens:[],AST:{},templateString:e.innerHTML};toffle.pendingTemplates.push(e.id);for(var o=!1,a="",r=0;r<n.templateString.length-1;r++){if(n.templateString.slice(r,r+2)==updOpen){if(a.length>0){var i=new toffle.tokenType.CONTENT;i.value=a,n.tokens.push(i),a=""}n.openTokens.push(r),o=!0}else if(n.templateString.slice(r,r+2)==updClose){r+=2,o=!1;var p=n.openTokens.pop(),l=n.templateString.slice(p,r);l=toffle.tokenify(l,e.id),l.tokenIndex=r-p,n.tokens.push(l)}o||(a+=n.templateString.charAt(r))}if(a.length>0){var i=new toffle.tokenType.CONTENT;i.value=a,n.tokens.push(i),a=""}if(n.openTokens.length>0)throw"toffle: Compilation failed! No closing '^>'";var s=toffle.generateTokenAST(n);n.AST=s,toffle.templates.push({name:e.id,temp:n})},toffle.tokenify=function(e,t){var n;if(e==updContentClose)return new toffle.tokenType.CLS;e=e.replace("<^",""),e=e.replace("^>",""),e=e.trim();var o=e.split(" ");switch(o[0]){case"plug":n=new toffle.tokenType.TEMP,n.template=o[1];for(var a=document.getElementById(n.template),r=!1,i=0;i<toffle.pendingTemplates.length;i++)if(toffle.pendingTemplates[i]==n.template){r=!0;break}if(n.template==t||r||toffle.compileTemplate(a,!1),o.length>2){for(var p="",l=2;l<o.length;l++)p+=o[l];n.params=p}else n.params="";break;case"for":if(n=new toffle.tokenType.FOR,!(o.length>3))throw"toffle: Compilation failed! Incorrect 'for' declaration.";if("in"!=o[2])throw"toffle: Compilation failed! Incorrect 'for' declaration, missing 'in'.";n.pointer=o[1],o.splice(0,3),n.reference=o.join(" ");break;case"if":if(n=new toffle.tokenType.IF,!(o.length>1))throw"toffle: Compilation failed! Missing 'if' condition.";o.splice(0,1),n.condition=o.join(" ");break;case"not":if(n=new toffle.tokenType.NOT,!(o.length>1))throw"toffle: Compilation failed! Missing 'not' condition.";o.splice(0,1),n.condition=o.join(" ");break;default:n=new toffle.tokenType.REF,n.value=e}return n},toffle.generateTokenAST=function(e){var t=[];t.push({tokens:[]});for(var n=0;n<e.tokens.length;n++){var o=e.tokens[n];if(o.wrapsTokens)t.push(o);else if("cls"==o.type){var a=t.pop();t[t.length-1].tokens.push(a)}else{var a=t[t.length-1];a.tokens.push(o)}}return t[0]},toffle.setParamJSON=function(e,t){t&&(toffle.$={});for(var n in e)toffle.$[n]=e[n]},toffle.raiseParams=function(e){for(var t in e)window[t]=e[t]},toffle.dropParams=function(e){for(var t in e)delete window[t]},toffle.parseParam=function(param){if(param=param.trim(),"{"==param.charAt(0)&&"}"==param.charAt(param.length-1)){param=JSON.parse(param);for(var key in param)if(param.hasOwnProperty(key)){var evaluatedValue;try{evaluatedValue=eval(param[key])}catch(err){evaluatedValue=param[key]}param[key]=evaluatedValue}return param}try{var evaluatedValue=eval(param);return evaluatedValue}catch(err){throw"toffle: Error evaluating parameter input: "+param}},toffle.destringToken=function(e){for(var t=e,n=[],o=0,a=/\"(.*?)\"/g,r=/\'(.*?)\'/g,i=!1;!i;){var p=a.exec(t);if(null!=p){{p.index}t=t.replace(p[0],"^UTR:"+o+"^"),n.push({id:o++,resource:p[0],value:p[1],pos:p.index})}else i=!0}for(i=!1;!i;){var p=r.exec(t);null!=p?(t=t.replace(p[0],"^UTR:"+o+"^"),n.push({id:o++,resource:p[0],value:p[1],pos:p.index})):i=!0}return{token:t,resourceLibrary:n}};