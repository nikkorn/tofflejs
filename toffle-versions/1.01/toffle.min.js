function toffle(){}var updOpen="<^",updClose="^>",updContentClose="<^/^>";toffle.tokenType={IF:function(){this.type="if",this.condition="",this.tokens=[],this.wrapsTokens=!0},NOT:function(){this.type="not",this.condition="",this.tokens=[],this.wrapsTokens=!0},REF:function(){this.type="ref",this.value="",this.wrapsTokens=!1},TEMP:function(){this.type="template",this.template="",this.params="",this.wrapsTokens=!1},FOR:function(){this.type="for",this.pointer="",this.reference="",this.tokens=[],this.wrapsTokens=!0},CONTENT:function(){this.type="content",this.value="",this.wrapsTokens=!1},CLS:function(){this.type="cls",this.wrapsTokens=!1}},toffle.templates=[],toffle.pendingTemplates=[],toffle.template=function(template){toffle.compileTemplate(template,!0);for(var returnObject=({templates:{},go:function(inputParams){var output="",workStack=[],context={pos:0,tokens:[],params:{},preParams:{},pointer:null,iterative:null,counter:1,iterations:1};for(var templateId in this.templates){var currentTemplate=this.templates[templateId];if(currentTemplate.isInitialTemplate){for(var i=0;i<currentTemplate.ast.tokens.length;i++)context.tokens.push(currentTemplate.ast.tokens[i]);context.params=inputParams,toffle.raiseParams(context.params),workStack.push(context);break}}for(;;){var context;if(0==workStack.length)break;if(context=workStack[workStack.length-1],context.pos==context.tokens.length){if(!(context.counter<context.iterations)){toffle.dropParams(context.params),toffle.raiseParams(context.preParams),workStack.pop();continue}context.counter=context.counter+1,context.pointer=context.iterative[context.counter-1],window[context.pointerIdent]=context.pointer,context.pos=0}var pos=context.pos,token=context.tokens[context.pos];switch(token.type){case"content":output+=token.value;break;case"ref":try{output+=eval(token.value)}catch(err){throw"toffle: error evaluating value '"+token.value+"'"}break;case"if":try{var condition=eval(token.condition)}catch(err){throw"toffle: error evaluating condition '"+token.condition+"'"}condition&&workStack.push({pos:0,tokens:token.tokens,params:{},preParams:{},pointer:null,iterative:null,counter:1,iterations:1});break;case"not":try{var condition=eval(token.condition)}catch(err){throw"toffle: error evaluating condition '"+token.condition+"'"}condition||workStack.push({pos:0,tokens:token.tokens,params:{},preParams:{},pointer:null,iterative:null,counter:1,iterations:1});break;case"for":var ref={},refLength=0;try{ref=eval(token.reference),refLength=ref.length}catch(err){throw"toffle: error evaluating reference '"+token.reference+"'"}workStack.push({pos:0,tokens:token.tokens,params:{},preParams:{},pointer:ref[0],pointerIdent:token.pointer,iterative:ref,counter:1,iterations:refLength}),window.hasOwnProperty(token.pointer)&&(workStack[workStack.length-1].preParams[token.pointer]=window[token.pointer]);try{window[token.pointer]=ref[0]}catch(err){throw"toffle: error setting variable"}break;case"template":for(var targetTemplate=this.templates[token.template],templateContext={pos:0,tokens:[],params:{},preParams:{},pointer:{},iterative:{},counter:1,iterations:1},i=0;i<targetTemplate.ast.tokens.length;i++)templateContext.tokens.push(targetTemplate.ast.tokens[i]);templateContext.params=toffle.parseParam(token.params);for(var key in templateContext.params)window.hasOwnProperty(key)&&(templateContext.preParams[key]=window[key]);toffle.raiseParams(templateContext.params),workStack.push(templateContext);break;default:throw"toffle: error! Unknown token type: "+token.type}context.pos=context.pos+1}return output},goAway:function(e){if(!e)throw"toffle: error! you must specify details for this function";if(!("url"in e))throw"toffle: error! no url specified";if(!("type"in e))throw"toffle: error! no type specified";try{var t;t=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");var o=this;t.onreadystatechange=function(){if(4==t.readyState&&200==t.status){var r;try{r=JSON.parse(t.responseText)}catch(n){return void o.handleAjaxError(e,n,"toffle: error parsing returned data as JSON")}var a;try{a=o.go(r)}catch(n){return void o.handleAjaxError(e,n,"toffle: error generating output")}if("dropoff"in e)try{e.dropoff.innerHTML=a}catch(n){return void o.handleAjaxError(e,n,"toffle: error! invalid dropoff")}"finished"in e&&e.finished({responseJSON:r,output:a})}},t.open(e.type,e.url,!0),"data"in e&&"POST"==e.type.toUpperCase()?t.send(e.data):t.send()}catch(r){this.handleAjaxError(e,r,"toffle: error carrying out ajax request")}},goOver:function(){},handleAjaxError:function(e,t,o){if(!("failed"in e))throw o;e.failed(t)}}),i=0;i<toffle.templates.length;i++)returnObject.templates[toffle.templates[i].name]={ast:toffle.templates[i].temp.AST,isInitialTemplate:toffle.templates[i].temp.initialTemplate,varList:[]};return returnObject},toffle.compileTemplate=function(e,t){if(null==e)throw"toffle: Compilation failed! Could not find Template.";var o={initialTemplate:t,tokens:[],openTokens:[],AST:{},templateString:e.innerHTML};toffle.pendingTemplates.push(e.id);for(var r=!1,n="",a=0;a<o.templateString.length-1;a++){if(o.templateString.slice(a,a+2)==updOpen){if(n.length>0){var i=new toffle.tokenType.CONTENT;i.value=n,o.tokens.push(i),n=""}o.openTokens.push(a),r=!0}else if(o.templateString.slice(a,a+2)==updClose){a+=2,r=!1;var p=o.openTokens.pop(),l=o.templateString.slice(p,a);l=toffle.tokenify(l,e.id),l.tokenIndex=a-p,o.tokens.push(l)}r||(n+=o.templateString.charAt(a))}if(n.length>0){var i=new toffle.tokenType.CONTENT;i.value=n,o.tokens.push(i),n=""}if(o.openTokens.length>0)throw"toffle: Compilation failed! No closing '^>'";var s=toffle.generateTokenAST(o);o.AST=s,toffle.templates.push({name:e.id,temp:o})},toffle.tokenify=function(e,t){var o;if(e==updContentClose)return new toffle.tokenType.CLS;e=e.replace("<^",""),e=e.replace("^>",""),e=e.trim();var r=e.split(" ");switch(r[0]){case"plug":o=new toffle.tokenType.TEMP,o.template=r[1];for(var n=document.getElementById(o.template),a=!1,i=0;i<toffle.pendingTemplates.length;i++)if(toffle.pendingTemplates[i]==o.template){a=!0;break}if(o.template==t||a||toffle.compileTemplate(n,!1),r.length>2){for(var p="",l=2;l<r.length;l++)p+=r[l];o.params=p}else o.params="";break;case"for":if(o=new toffle.tokenType.FOR,!(r.length>3))throw"toffle: Compilation failed! Incorrect 'for' declaration.";if("in"!=r[2])throw"toffle: Compilation failed! Incorrect 'for' declaration, missing 'in'.";o.pointer=r[1],r.splice(0,3),o.reference=r.join(" ");break;case"if":if(o=new toffle.tokenType.IF,!(r.length>1))throw"toffle: Compilation failed! Missing 'if' condition.";r.splice(0,1),o.condition=r.join(" ");break;case"not":if(o=new toffle.tokenType.NOT,!(r.length>1))throw"toffle: Compilation failed! Missing 'not' condition.";r.splice(0,1),o.condition=r.join(" ");break;default:o=new toffle.tokenType.REF,o.value=e}return o},toffle.generateTokenAST=function(e){var t=[];t.push({tokens:[]});for(var o=0;o<e.tokens.length;o++){var r=e.tokens[o];if(r.wrapsTokens)t.push(r);else if("cls"==r.type){var n=t.pop();t[t.length-1].tokens.push(n)}else{var n=t[t.length-1];n.tokens.push(r)}}return t[0]},toffle.raiseParams=function(e){for(var t in e)window[t]=e[t]},toffle.dropParams=function(e){for(var t in e)delete window[t]},toffle.parseParam=function(param){if(param=param.trim(),"{"==param.charAt(0)&&"}"==param.charAt(param.length-1)){param=JSON.parse(param);for(var key in param)if(param.hasOwnProperty(key)){var evaluatedValue;try{evaluatedValue=eval(param[key])}catch(err){evaluatedValue=param[key]}param[key]=evaluatedValue}return param}try{var evaluatedValue=eval(param);return evaluatedValue}catch(err){throw"toffle: Error evaluating parameter input: "+param}},toffle.destringToken=function(e){for(var t=e,o=[],r=0,n=/\"(.*?)\"/g,a=/\'(.*?)\'/g,i=!1;!i;){var p=n.exec(t);if(null!=p){{p.index}t=t.replace(p[0],"^UTR:"+r+"^"),o.push({id:r++,resource:p[0],value:p[1],pos:p.index})}else i=!0}for(i=!1;!i;){var p=a.exec(t);null!=p?(t=t.replace(p[0],"^UTR:"+r+"^"),o.push({id:r++,resource:p[0],value:p[1],pos:p.index})):i=!0}return{token:t,resourceLibrary:o}};